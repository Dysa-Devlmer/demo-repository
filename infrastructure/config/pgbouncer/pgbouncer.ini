# =============================================================================
# ðŸš€ CHATBOTDYSA ENTERPRISE+++++ PGBOUNCER CONFIGURATION
# Advanced Connection Pooling for Fortune 500 Database Operations
# =============================================================================

[databases]
# ChatBotDysa Enterprise Database
chatbotdysa_enterprise = host=postgres-master port=5432 dbname=chatbotdysa_enterprise pool_size=50 reserve_pool=10

# Template databases (for maintenance)
template1 = host=postgres-master port=5432 dbname=template1 pool_size=5
postgres = host=postgres-master port=5432 dbname=postgres pool_size=5

# Development database (if needed)
chatbotdysa_dev = host=postgres-master port=5432 dbname=chatbotdysa_dev pool_size=10

# =============================================================================
# ENTERPRISE PGBOUNCER SETTINGS
# =============================================================================

[pgbouncer]
# Enterprise Connection Settings
listen_addr = 0.0.0.0
listen_port = 6432
unix_socket_dir = /tmp
user = pgbouncer
auth_file = /etc/pgbouncer/userlist.txt
auth_type = scram-sha-256                     # Enterprise: Strong authentication

# Enterprise Pool Configuration
pool_mode = transaction                       # Enterprise: Transaction-level pooling
max_client_conn = 1000                        # Enterprise: High client connection limit
default_pool_size = 50                        # Enterprise: Large default pool
min_pool_size = 10                           # Enterprise: Minimum pool size
reserve_pool_size = 10                       # Enterprise: Reserve connections
reserve_pool_timeout = 5                     # Enterprise: Reserve timeout (seconds)

# Database Connection Limits
max_db_connections = 100                      # Enterprise: Max database connections
max_user_connections = 100                    # Enterprise: Max per-user connections

# Enterprise Connection Management
server_lifetime = 3600                       # Enterprise: Connection lifetime (1 hour)
server_idle_timeout = 600                    # Enterprise: Idle timeout (10 minutes)
server_connect_timeout = 15                  # Enterprise: Connect timeout (15 seconds)
server_login_retry = 15                      # Enterprise: Login retry (15 seconds)

# Query Settings for Enterprise Workloads
query_timeout = 300                          # Enterprise: Query timeout (5 minutes)
query_wait_timeout = 120                     # Enterprise: Query wait timeout (2 minutes)
client_idle_timeout = 0                     # Enterprise: No client idle timeout
client_login_timeout = 60                   # Enterprise: Client login timeout (1 minute)

# Enterprise Transaction Settings
server_reset_query = DISCARD ALL             # Enterprise: Reset connections
server_reset_query_always = 0               # Enterprise: Reset only when needed
server_check_delay = 30                     # Enterprise: Health check delay (30 seconds)
server_check_query = SELECT 1               # Enterprise: Health check query

# Enterprise Security Settings
ignore_startup_parameters = extra_float_digits,search_path
disable_pqexec = 0                          # Enterprise: Allow multi-statement queries
application_name_add_host = 1               # Enterprise: Add hostname to application name

# Enterprise Performance Tuning
listen_backlog = 4096                       # Enterprise: High listen backlog
sbuf_loopcnt = 5                           # Enterprise: Socket buffer loop count
suspend_timeout = 10                        # Enterprise: Suspend timeout (10 seconds)
tcp_defer_accept = 45                       # Enterprise: TCP defer accept (45 seconds)
tcp_socket_buffer = 0                       # Enterprise: Use system default
tcp_keepalive = 1                           # Enterprise: Enable TCP keepalive
tcp_keepcnt = 9                             # Enterprise: TCP keepalive count
tcp_keepidle = 7200                         # Enterprise: TCP keepalive idle (2 hours)
tcp_keepintvl = 75                          # Enterprise: TCP keepalive interval (75 seconds)
tcp_user_timeout = 0                        # Enterprise: Use system default

# Enterprise Logging Configuration
log_connections = 1                         # Enterprise: Log all connections
log_disconnections = 1                      # Enterprise: Log all disconnections
log_pooler_errors = 1                       # Enterprise: Log pooler errors
log_stats = 1                              # Enterprise: Log statistics
stats_period = 60                          # Enterprise: Stats period (1 minute)

# Enterprise Admin Interface
admin_users = pgbouncer,chatbot_admin        # Enterprise: Admin users
stats_users = stats,monitoring               # Enterprise: Stats users

# Enterprise Verbose Logging (for troubleshooting)
verbose = 0                                 # Enterprise: Normal verbosity
syslog = 0                                  # Enterprise: Use stdout/stderr
syslog_facility = daemon                    # Enterprise: Syslog facility
syslog_ident = pgbouncer                    # Enterprise: Syslog identifier

# Enterprise DNS and Network Settings
dns_max_ttl = 15                           # Enterprise: DNS cache TTL (15 seconds)
dns_nxdomain_ttl = 15                      # Enterprise: DNS negative cache TTL
dns_zone_check_period = 0                  # Enterprise: Disable DNS zone checks

# Enterprise Memory Management
pkt_buf = 4096                             # Enterprise: Packet buffer size (4KB)
max_packet_size = 2147483647               # Enterprise: Max packet size (2GB)
sbuf_loopcnt = 5                           # Enterprise: Send buffer loop count

# =============================================================================
# ENTERPRISE SECURITY AND MONITORING
# =============================================================================

# SSL Configuration (uncomment for SSL)
# server_tls_sslmode = require
# server_tls_ca_file = /etc/ssl/certs/ca.crt
# server_tls_cert_file = /etc/ssl/certs/pgbouncer.crt
# server_tls_key_file = /etc/ssl/private/pgbouncer.key
# server_tls_protocols = secure
# server_tls_ciphers = HIGH:MEDIUM:+3DES:!aNULL

# Client SSL Configuration
# client_tls_sslmode = allow
# client_tls_ca_file = /etc/ssl/certs/ca.crt
# client_tls_cert_file = /etc/ssl/certs/pgbouncer.crt
# client_tls_key_file = /etc/ssl/private/pgbouncer.key
# client_tls_protocols = secure
# client_tls_ciphers = HIGH:MEDIUM:+3DES:!aNULL

# =============================================================================
# ENTERPRISE PERFORMANCE NOTES
# =============================================================================
#
# Pool Mode Selection:
# - session: One connection per client session (lowest overhead)
# - transaction: One connection per transaction (recommended for web apps)
# - statement: One connection per statement (highest connection reuse)
#
# Enterprise Recommendations:
# - Use transaction mode for web applications (ChatBotDysa)
# - Monitor pool saturation and adjust pool sizes accordingly
# - Set appropriate timeouts based on application requirements
# - Enable connection logging for security auditing
# - Use SSL in production environments
# - Regular monitoring of pool statistics
#
# Scaling Guidelines:
# - default_pool_size: Start with (CPU cores * 2) and adjust based on load
# - max_client_conn: Should handle peak concurrent clients
# - reserve_pool_size: 10-20% of default_pool_size for high-priority connections
# - server_lifetime: Balance between connection reuse and avoiding stale connections
#
# =============================================================================