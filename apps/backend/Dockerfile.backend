# Dockerfile para ChatBotDysa Backend
FROM node:20-alpine

# Instalar dependencias necesarias
RUN apk add --no-cache curl postgresql-client

# Crear directorio de trabajo
WORKDIR /app

# Copiar archivos de configuraciÃ³n de la raÃ­z
COPY package*.json ./

# Instalar dependencias
RUN npm install

# Copiar cÃ³digo fuente del backend
COPY apps/backend ./apps/backend

# Copiar archivos de configuraciÃ³n necesarios
COPY .env ./

# Construir el backend
WORKDIR /app/apps/backend
RUN npm install
RUN npm run build

# Exponer puerto
EXPOSE 3000

# Crear script de inicio que espera la base de datos
WORKDIR /app
RUN cat > start-backend.sh << 'EOF'
#!/bin/sh
echo "ğŸš€ Iniciando ChatBotDysa Backend en Docker"

# Esperar a que PostgreSQL estÃ© listo
until pg_isready -h postgres -p 5432 -U postgres; do
  echo "â³ Esperando PostgreSQL..."
  sleep 2
done

echo "âœ… PostgreSQL estÃ¡ listo"

# Esperar a que Redis estÃ© listo
until echo "ping" | nc redis 6379 | grep -q "PONG"; do
  echo "â³ Esperando Redis..."
  sleep 2
done

echo "âœ… Redis estÃ¡ listo"

# Verificar Ollama
if curl -s http://ollama:11434/api/version > /dev/null; then
  echo "âœ… Ollama estÃ¡ listo"
else
  echo "âš ï¸ Ollama no responde, pero continuando..."
fi

echo "ğŸ¯ Iniciando Backend API..."
cd /app/apps/backend && npm run start:prod
EOF

RUN chmod +x start-backend.sh

# Comando de inicio
CMD ["./start-backend.sh"]